<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro AI å»èƒŒ (é€šç”¨ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { margin: 0; padding: 20px; background-color: var(--bg); color: var(--text); font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .container { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 20px; }
        
        label.upload-card {
            background: var(--card); border: 2px dashed #475569; border-radius: 16px; padding: 30px 20px;
            text-align: center; cursor: pointer; display: block;
        }
        
        .result-card { background: var(--card); border-radius: 16px; padding: 15px; display: none; }
        
        /* æ£‹ç›¤æ ¼èƒŒæ™¯ */
        canvas {
            width: 100%; height: auto; border-radius: 12px;
            background-image: linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%);
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; background-color: #333;
        }

        .btn { background: var(--primary); color: white; display: block; text-align: center; padding: 14px; border-radius: 12px; text-decoration: none; margin-top: 15px; font-weight: bold;}
        
        #loader { position: fixed; inset: 0; background: rgba(15,23,42,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99; }
        .spinner { width: 40px; height: 40px; border: 3px solid #fff3; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* è­¦å‘Šè¨Šæ¯ */
        .warning-box {
            background: #f59e0b20; border: 1px solid #f59e0b; color: #fbbf24;
            padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; display: none;
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:15px; color:#cbd5e1;">æ­£åœ¨å•Ÿå‹• AI æ ¸å¿ƒ...</div>
    </div>

    <h2 style="margin-bottom: 5px;">Pro AI å»èƒŒ (ä¿®æ­£ç‰ˆ)</h2>
    <p style="color:#94a3b8; font-size: 13px; margin-bottom: 20px;">å°ˆç”¨æ–¼äººåƒè™•ç† â€¢ åƒç´ ç´šä¿®æ­£</p>

    <div class="container">
        <label class="upload-card" id="upload-box">
            <div style="font-size: 40px;">ğŸ“¸</div>
            <div style="margin:10px 0; font-weight:bold;">é»æ“Šé¸æ“‡ç…§ç‰‡</div>
            <div style="font-size:12px; color:#94a3b8;">è«‹ç¢ºä¿ç…§ç‰‡ä¸­æœ‰æ˜é¡¯çš„ã€Œäººç‰©ã€</div>
            <input type="file" id="file-input" accept="image/*" style="display:none;">
        </label>

        <div class="result-card" id="result-card">
            <div class="warning-box" id="warning-msg">âš ï¸ åµæ¸¬ä¸åˆ°äººç‰©ï¼Œé¡¯ç¤ºåŸåœ–</div>
            <canvas id="output-canvas"></canvas>
            <a id="download-btn" class="btn" download="result.png">ä¸‹è¼‰åœ–ç‰‡</a>
            <div style="text-align:center; margin-top:10px;">
                <button onclick="location.reload()" style="background:none; border:none; color:#94a3b8; text-decoration:underline; padding:10px;">é‡è©¦</button>
            </div>
        </div>
    </div>

    <canvas id="temp-canvas" style="display:none;"></canvas>

    <script>
        const loader = document.getElementById('loader');
        const fileInput = document.getElementById('file-input');
        const outputCanvas = document.getElementById('output-canvas');
        const tempCanvas = document.getElementById('temp-canvas');
        const warningMsg = document.getElementById('warning-msg');
        
        let selfieSegmentation = null;

        async function initAI() {
            try {
                selfieSegmentation = new SelfieSegmentation({locateFile: (file) => 
                    `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
                
                selfieSegmentation.setOptions({ modelSelection: 1 });
                selfieSegmentation.onResults(onResults);
                
                // é ç†±
                const img = new Image();
                img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
                img.onload = () => selfieSegmentation.send({image: img}).then(() => {
                    loader.style.display = 'none';
                });
            } catch(e) {
                alert("æ¨¡å‹è¼‰å…¥å¤±æ•—");
                loader.style.display = 'none';
            }
        }

        fileInput.addEventListener('change', (e) => {
            if(e.target.files.length === 0) return;
            const img = new Image();
            img.onload = () => {
                loader.style.display = 'flex';
                // é™åˆ¶å°ºå¯¸ä»¥é˜²å´©æ½°
                const max = 1024;
                let w = img.width, h = img.height;
                if(w > max) { h = Math.round(h*(max/w)); w = max; }
                
                outputCanvas.width = w; outputCanvas.height = h;
                tempCanvas.width = w; tempCanvas.height = h;
                
                const ctx = tempCanvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                selfieSegmentation.send({image: tempCanvas});
            };
            img.src = URL.createObjectURL(e.target.files[0]);
        });

        function onResults(results) {
            const width = results.image.width;
            const height = results.image.height;
            const ctx = outputCanvas.getContext('2d');

            ctx.clearRect(0, 0, width, height);
            ctx.drawImage(results.image, 0, 0, width, height);
            
            // å–å¾—åœ–ç‰‡åƒç´ 
            const imageData = ctx.getImageData(0, 0, width, height);
            const pixelData = imageData.data;
            
            // è™•ç† Maskï¼šMediaPipe Mask æ˜¯ä¸€å€‹ ImageBitmap
            // æˆ‘å€‘éœ€è¦æŠŠå®ƒç•«åˆ°å¦ä¸€å€‹ Canvas æ‰èƒ½è®€å–æ•¸æ“š
            const maskCanvas = document.createElement('canvas');
            maskCanvas.width = width;
            maskCanvas.height = height;
            const maskCtx = maskCanvas.getContext('2d');
            maskCtx.drawImage(results.segmentationMask, 0, 0, width, height);
            const maskData = maskCtx.getImageData(0, 0, width, height).data;

            let personPixelCount = 0;
            const totalPixels = width * height;

            // åƒç´ ç´šæ··åˆ (æœ€ç©©å®šçš„æ–¹æ³•)
            for (let i = 0; i < totalPixels; i++) {
                // maskData çš„ R, G, B éƒ½æ˜¯ä¸€æ¨£çš„å€¼ (0~255)
                // 255 = äºº, 0 = èƒŒæ™¯ (æˆ–æ˜¯åŠé€æ˜)
                const maskValue = maskData[i * 4]; 
                
                // å¦‚æœ Mask å€¼å¤§æ–¼ 10 (å¾ˆå¯¬é¬†)ï¼Œå°±ç•¶ä½œæ˜¯äºº
                if (maskValue > 10) {
                    // æŠŠåŸæœ¬åœ–ç‰‡çš„ Alpha å€¼è¨­ç‚º maskValue (å¯¦ç¾æŸ”é‚Š)
                    pixelData[i * 4 + 3] = maskValue; 
                    personPixelCount++;
                } else {
                    // æ²’äºº -> é€æ˜
                    pixelData[i * 4 + 3] = 0;
                }
            }

            // åˆ¤æ–·æ˜¯å¦åµæ¸¬å¤±æ•—
            const personRatio = personPixelCount / totalPixels;
            if (personRatio < 0.01) { // ç•«é¢ä¸­ä¸åˆ° 1% æ˜¯äºº
                warningMsg.style.display = 'block';
                warningMsg.innerText = "âš ï¸ åµæ¸¬ä¸åˆ°äººç‰©ï¼Œè«‹è©¦è‘—ä¸Šå‚³æœ‰æ˜é¡¯äººåƒçš„ç…§ç‰‡";
                // æ¢å¾©åŸåœ–é¡¯ç¤ºï¼Œä¸è¦çµ¦é€æ˜åœ–
                ctx.drawImage(results.image, 0, 0, width, height);
            } else {
                warningMsg.style.display = 'none';
                ctx.putImageData(imageData, 0, 0);
            }

            document.getElementById('upload-box').style.display = 'none';
            document.getElementById('result-card').style.display = 'block';
            document.getElementById('download-btn').href = outputCanvas.toDataURL('image/png');
            loader.style.display = 'none';
        }

        initAI();
    </script>
</body>
</html>
