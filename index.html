<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI åœ–ç‰‡å»èƒŒ (iPad/iOS å„ªåŒ–ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.5/dist/imgly-background-removal.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
            /* é˜²æ­¢ iOS æ©¡çš®ç­‹æ•ˆæœ */
            overscroll-behavior-y: none;
        }

        .container {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        h1 { margin: 10px 0; font-size: 1.5rem; color: #2c3e50; }

        /* ç‹€æ…‹åˆ— */
        .status-box {
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            color: #e67e22;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 50px;
        }
        
        .status-box.ready {
            background: #e8f8f5;
            border-color: #d1f2eb;
            color: #27ae60;
        }
        
        .status-box.error {
            background: #fadbd8;
            border-color: #f5b7b1;
            color: #c0392b;
        }

        .spinner {
            width: 18px; height: 18px;
            border: 2px solid rgba(0,0,0,0.1);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ä¸Šå‚³å€å¡Š */
        .upload-section {
            border: 2px dashed #bdc3c7;
            padding: 40px 20px;
            border-radius: 15px;
            position: relative;
            background: #fafafa;
            transition: all 0.3s;
            /* é è¨­ç¦æ­¢äº’å‹•ï¼Œç›´åˆ°æ¨¡å‹è¼‰å…¥å®Œæˆ */
            opacity: 0.5;
            pointer-events: none;
        }

        .upload-section.active {
            border-color: #3498db;
            background: #fff;
            opacity: 1;
            pointer-events: auto;
            cursor: pointer;
        }

        /* è¦†è“‹æ•´å€‹å€åŸŸçš„ inputï¼Œç¢ºä¿ iPad å¥½é»æ“Š */
        input[type="file"] {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* æ‰‹å‹•å•Ÿå‹•æŒ‰éˆ• (ç•¶è‡ªå‹•å¤±æ•—æ™‚é¡¯ç¤º) */
        #retryBtn {
            display: none;
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 5px;
        }

        /* é è¦½å€ */
        .preview-area {
            display: none;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* å¹³æ¿ä»¥ä¸Šæ”¹ç‚ºä¸¦æ’ */
        @media (min-width: 600px) {
            .preview-area { flex-direction: row; }
        }

        .image-box {
            flex: 1;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 12px;
            background: #fff;
        }

        img {
            max-width: 100%;
            border-radius: 8px;
            /* æ£‹ç›¤æ ¼èƒŒæ™¯ */
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%), 
                              linear-gradient(-45deg, #eee 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #eee 75%), 
                              linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .btn-download {
            display: inline-block;
            background-color: #27ae60;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            text-decoration: none;
            margin-top: 15px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(39, 174, 96, 0.2);
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>AI åœ–ç‰‡å»èƒŒ</h1>
        
        <div id="statusBox" class="status-box">
            <div class="spinner"></div>
            <span id="statusText">ç³»çµ±å•Ÿå‹•ä¸­...</span>
            <button id="retryBtn" onclick="initModel(true)">ğŸ‘† é»æ­¤æ‰‹å‹•ä¸‹è¼‰ AI æ¨¡å‹</button>
        </div>

        <div class="upload-section" id="uploadSection">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“·</div>
            <p id="uploadText">è«‹ç¨å€™ï¼ŒAI å¼•æ“æ­£åœ¨æš–æ©Ÿ...</p>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div class="preview-area" id="previewArea">
            <div class="image-box">
                <h3>åŸå§‹åœ–ç‰‡</h3>
                <img id="originalImg" src="" alt="Original">
            </div>
            <div class="image-box">
                <h3>å»èƒŒçµæœ</h3>
                <img id="resultImg" src="" alt="Result">
                <br>
                <a id="downloadLink" class="btn-download">ä¸‹è¼‰å»èƒŒåœ–ç‰‡</a>
            </div>
        </div>
    </div>

    <script>
        const statusBox = document.getElementById('statusBox');
        const statusText = document.getElementById('statusText');
        const retryBtn = document.getElementById('retryBtn');
        const uploadSection = document.getElementById('uploadSection');
        const uploadText = document.getElementById('uploadText');
        const fileInput = document.getElementById('fileInput');
        const previewArea = document.getElementById('previewArea');
        const originalImg = document.getElementById('originalImg');
        const resultImg = document.getElementById('resultImg');
        const downloadLink = document.getElementById('downloadLink');

        // ä½¿ç”¨ jsDelivr CDNï¼Œé€™åœ¨å°ç£é€£ç·šé€šå¸¸æ¯”è¼ƒå¿«ä¸”ç©©å®š
        const CDN_URL = "https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.5.5/dist/";

        const config = {
            publicPath: CDN_URL,
            progress: (key, current, total) => {
                if(isModelReady) return;
                const percent = total > 0 ? Math.round((current / total) * 100) : 0;
                statusText.innerText = `ğŸ“¦ æ­£åœ¨ä¸‹è¼‰ AI çµ„ä»¶... ${percent}%`;
            }
        };

        let isModelReady = false;

        // åˆå§‹åŒ–æ¨¡å‹å‡½æ•¸
        async function initModel(isManual = false) {
            // å¦‚æœæ˜¯æ‰‹å‹•é‡è©¦ï¼Œå…ˆéš±è—æŒ‰éˆ•ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­
            if (isManual) {
                retryBtn.style.display = 'none';
                statusBox.classList.remove('error');
                statusBox.querySelector('.spinner').style.display = 'block';
                statusText.innerText = "å˜—è©¦é‡æ–°é€£ç·šä¸­...";
            }

            try {
                // 1. æ¸¬è©¦ç”¨é€æ˜å°åœ–
                const dummyImage = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
                
                // 2. åŸ·è¡Œé è¼‰
                await imgly.removeBackground(dummyImage, config);
                
                // 3. æˆåŠŸç‹€æ…‹æ›´æ–°
                isModelReady = true;
                statusBox.classList.remove('error');
                statusBox.classList.add('ready');
                statusBox.innerHTML = 'âœ… AI æº–å‚™å®Œæˆï¼Œè«‹é¸æ“‡ç…§ç‰‡ï¼';
                
                uploadSection.classList.add('active');
                uploadText.innerHTML = '<b>é»æ“Šé€™è£¡ä¸Šå‚³åœ–ç‰‡</b><br><span style="font-size:12px;color:#999">æ”¯æ´ JPG / PNG</span>';
                
            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±æ•—:", error);
                
                // å¤±æ•—ç‹€æ…‹æ›´æ–°
                isModelReady = false;
                statusBox.classList.add('error');
                statusBox.querySelector('.spinner').style.display = 'none';
                
                // é‡å° iOS é¡¯ç¤ºå…·é«”å»ºè­°
                statusText.innerText = "âš ï¸ è‡ªå‹•ä¸‹è¼‰è¢«æ””æˆª (iOS çœé›»æ¨¡å¼)";
                retryBtn.style.display = 'inline-block'; // é¡¯ç¤ºæ‰‹å‹•æŒ‰éˆ•
            }
        }

        // é é¢è¼‰å…¥å¾Œå˜—è©¦è‡ªå‹•åŸ·è¡Œ
        window.onload = () => initModel(false);

        // è™•ç†åœ–ç‰‡ä¸Šå‚³
        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // é¡¯ç¤ºé è¦½
            const originalUrl = URL.createObjectURL(file);
            originalImg.src = originalUrl;
            previewArea.style.display = 'flex'; // iPad ä¸Šæœƒè®Šæˆä¸Šä¸‹æ’åˆ—
            resultImg.src = ''; 
            downloadLink.style.display = 'none';
            
            // UI åˆ‡æ›ç‚ºè™•ç†ä¸­
            statusBox.classList.remove('ready');
            statusBox.style.background = '#eef7fc';
            statusBox.style.color = '#2980b9';
            statusBox.innerHTML = '<div class="spinner"></div> æ­£åœ¨å»èƒŒä¸­ï¼Œè«‹ç¨å€™...';

            try {
                // æ­£å¼å»èƒŒ
                const blob = await imgly.removeBackground(file, config);
                const url = URL.createObjectURL(blob);
                
                resultImg.src = url;
                downloadLink.href = url;
                downloadLink.download = 'removed-bg.png';
                downloadLink.style.display = 'inline-block';
                
                // æ¢å¾©å®Œæˆç‹€æ…‹
                statusBox.classList.add('ready');
                statusBox.innerHTML = 'âœ¨ è™•ç†å®Œæˆï¼å¯ä»¥ä¸‹è¼‰äº†';

            } catch (error) {
                console.error(error);
                statusBox.classList.add('error');
                statusBox.innerText = 'âŒ è™•ç†å¤±æ•—: ' + error.message;
                alert("å»èƒŒç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é å†è©¦ä¸€æ¬¡ã€‚");
            }
        });
    </script>
</body>
</html>
