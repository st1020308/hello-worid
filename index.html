<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ä¸€éµå»èƒŒ (On-Device)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        header {
            width: 100%;
            background: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            color: #111;
        }

        .subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .container {
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding-bottom: 40px;
        }

        /* ä¸Šå‚³å€åŸŸæ¨£å¼ */
        .upload-box {
            width: 100%;
            height: 150px;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .upload-box:active {
            background-color: #f1f5f9;
            border-color: #94a3b8;
        }

        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        #file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* çµæœé¡¯ç¤ºå€ */
        .result-area {
            width: 100%;
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* é€æ˜èƒŒæ™¯æ ¼ç´‹æ•ˆæœ */
        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%),
                              linear-gradient(-45deg, #eee 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, #eee 75%),
                              linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 1px solid #e2e8f0;
        }

        .btn {
            background-color: #2563eb;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            text-align: center;
            text-decoration: none;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
            display: inline-block;
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* è¼‰å…¥å‹•ç•« */
        #status-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="status-modal">
        <div class="spinner"></div>
        <h3 id="status-text">æ­£åœ¨ä¸‹è¼‰ AI æ¨¡å‹...</h3>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">(åˆæ¬¡è¼‰å…¥è¼ƒæ…¢ï¼Œè«‹ç¨å€™)</p>
    </div>

    <header>
        <h1>AI æ‹ç«‹å¾—å»èƒŒæ©Ÿ</h1>
        <div class="subtitle">Client-side AI â€¢ Privacy First</div>
    </header>

    <div class="container">
        <div class="upload-box">
            <input type="file" id="file-input" accept="image/*">
            <div class="upload-icon">ğŸ“·</div>
            <div style="font-weight: 500; color: #475569;">é»æ“Šæ‹ç…§æˆ–ä¸Šå‚³åœ–ç‰‡</div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">æ”¯æ´é›¢ç·šé‹ç®—</div>
        </div>

        <div class="result-area" id="result-area">
            <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:bold; color:#2563eb;">å»èƒŒçµæœï¼š</span>
                <span style="font-size:12px; color:#666;" id="process-time"></span>
            </div>
            
            <canvas id="output-canvas"></canvas>
            
            <a id="download-btn" class="btn" download="removed-bg.png">ä¸‹è¼‰ PNG åœ–ç‰‡</a>
            <button onclick="location.reload()" style="background:transparent; border:none; color:#666; margin-top:15px; text-decoration:underline;">å†è©¦ä¸€å¼µ</button>
        </div>
    </div>

    <script>
        const statusModal = document.getElementById('status-modal');
        const statusText = document.getElementById('status-text');
        const fileInput = document.getElementById('file-input');
        const resultArea = document.getElementById('result-area');
        const canvas = document.getElementById('output-canvas');
        const downloadBtn = document.getElementById('download-btn');
        let net = null;

        // 1. è¼‰å…¥ BodyPix æ¨¡å‹
        async function loadModel() {
            try {
                // ä½¿ç”¨ MobileNetV1 æ¶æ§‹ï¼Œé©åˆæ‰‹æ©Ÿï¼Œé€Ÿåº¦å¿«
                net = await bodyPix.load({
                    architecture: 'MobileNetV1',
                    outputStride: 16,
                    multiplier: 0.75, // 0.75 è¼ƒè¼•é‡ï¼Œ0.5 æ›´å¿«ä½†è¼ƒä¸æº–ï¼Œ1.0 æœ€æº–ä½†æ…¢
                    quantBytes: 2
                });
                
                statusModal.classList.add('hidden');
                console.log('Model loaded');
            } catch (err) {
                statusText.innerText = "æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                console.error(err);
            }
        }

        // 2. è™•ç†åœ–ç‰‡
        fileInput.addEventListener('change', async function(e) {
            if (e.target.files.length === 0) return;

            const file = e.target.files[0];
            const img = new Image();
            const url = URL.createObjectURL(file);

            img.onload = async function() {
                // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
                statusText.innerText = "AI æ­£åœ¨å»èƒŒä¸­...";
                statusModal.classList.remove('hidden');
                
                // çµ¦ UI ä¸€é»æ™‚é–“æ¸²æŸ“
                setTimeout(async () => {
                    await removeBackground(img);
                }, 100);
            };
            img.src = url;
        });

        // 3. å»èƒŒé‚è¼¯
        async function removeBackground(imgElement) {
            const startTime = performance.now();

            // è¨­å®š Canvas å¤§å°
            // ç‚ºäº†æ•ˆèƒ½ï¼Œæ‰‹æ©Ÿä¸Šå¦‚æœåœ–ç‰‡å¤ªå¤§å¯ä»¥ç¨å¾®ç¸®å°ï¼Œé€™è£¡ç¶­æŒåŸåœ–æˆ–é™åˆ¶æœ€å¤§å¯¬åº¦
            const maxWidth = 800;
            let width = imgElement.width;
            let height = imgElement.height;
            
            if (width > maxWidth) {
                height = height * (maxWidth / width);
                width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // ç¹ªè£½åŸåœ–åˆ° Canvas (ç‚ºäº†è®“ BodyPix è®€å–åƒç´ )
            ctx.drawImage(imgElement, 0, 0, width, height);

            // åŸ·è¡Œåˆ†å‰² (Segmentation)
            // segmentPerson: ç”¨æ–¼åˆ†å‰²å‡ºå–®å€‹äººé«”
            const segmentation = await net.segmentPerson(canvas, {
                flipHorizontal: false,
                internalResolution: 'medium', // 'low', 'medium', 'high'
                segmentationThreshold: 0.7
            });

            // å–å¾—åƒç´ æ•¸æ“š
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            // æ ¹æ“š Mask ä¿®æ”¹ Alpha Channel
            // segmentation.data æ˜¯ä¸€å€‹é™£åˆ—ï¼Œ1 ä»£è¡¨æ˜¯äººï¼Œ0 ä»£è¡¨èƒŒæ™¯
            for (let i = 0; i < data.length; i += 4) {
                const maskIndex = i / 4;
                // å¦‚æœ Mask æ˜¯ 0 (èƒŒæ™¯)ï¼Œå°‡ Alpha (data[i+3]) è¨­ç‚º 0 (é€æ˜)
                if (segmentation.data[maskIndex] === 0) {
                    data[i + 3] = 0; 
                }
            }

            // å°‡è™•ç†å¾Œçš„åƒç´ æ”¾å› Canvas
            ctx.putImageData(imageData, 0, 0);

            // è¨ˆç®—æ™‚é–“
            const endTime = performance.now();
            const timeDiff = Math.round(endTime - startTime);

            // æ›´æ–° UI
            statusModal.classList.add('hidden');
            resultArea.style.display = 'flex';
            document.querySelector('.upload-box').style.display = 'none'; // éš±è—ä¸Šå‚³æ¡†
            document.getElementById('process-time').innerText = `è€—æ™‚: ${timeDiff} ms`;

            // è¨­å®šä¸‹è¼‰é€£çµ
            downloadBtn.href = canvas.toDataURL('image/png');
        }

        // åˆå§‹åŒ–
        loadModel();

    </script>
</body>
</html>
