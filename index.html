<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miku AR Filter - AI On-Device</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        /* 初音風格配色 */
        h1 {
            position: absolute;
            top: 10px;
            color: #39C5BB; /* Miku Green */
            text-shadow: 0 0 10px #e1008d; /* Miku Magenta shadow */
            z-index: 10;
            font-size: 1.5rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #39C5BB;
        }

        #canvas-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            position: absolute;
            transform: scaleX(-1); /* 鏡像翻轉，像照鏡子一樣 */
            max-width: 100%;
            max-height: 100%;
        }

        video {
            display: none; /* 隱藏原始影片，只顯示 Canvas */
        }

        #status {
            position: absolute;
            bottom: 20px;
            color: white;
            background: rgba(57, 197, 187, 0.8);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1rem;
            z-index: 20;
        }

        /* 掃描線特效 */
        .scanline {
            width: 100%;
            height: 100%;
            z-index: 5;
            background: linear-gradient(0deg, rgba(0,0,0,0) 50%, rgba(57, 197, 187, 0.05) 50%);
            background-size: 100% 4px;
            position: absolute;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <h1>MIKU AR SYSTEM</h1>
    
    <div id="canvas-wrapper">
        <div class="scanline"></div>
        <video id="video" playsinline></video>
        <canvas id="output"></canvas>
    </div>

    <div id="status">正在啟動神經網路... (請稍候)</div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('output');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        let net;

        // 1. 設定攝影機
        async function setupCamera() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('瀏覽器不支援 Camera API');
            }

            const stream = await navigator.mediaDevices.getUserMedia({
                'audio': false,
                'video': {
                    facingMode: 'user', // 使用前置鏡頭
                    width: 640,
                    height: 480
                }
            });
            video.srcObject = stream;

            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        }

        // 2. 繪製初音的雙馬尾 (程式繪圖，不需外部圖片)
        function drawMikuHair(keypoints) {
            // 找到左耳和右耳
            const leftEar = keypoints.find(k => k.part === 'leftEar');
            const rightEar = keypoints.find(k => k.part === 'rightEar');

            // 只有當信心分數夠高時才畫
            const minConfidence = 0.5;

            if (leftEar && leftEar.score > minConfidence && rightEar && rightEar.score > minConfidence) {
                
                // 設定頭髮樣式
                ctx.fillStyle = "rgba(57, 197, 187, 0.8)"; // Miku Green
                ctx.strokeStyle = "#2a9d96";
                ctx.lineWidth = 2;

                // 計算頭部大小 (兩耳距離)
                const earDist = Math.abs(leftEar.position.x - rightEar.position.x);
                const hairWidth = earDist * 0.8;
                const hairLength = earDist * 6;

                // 畫左邊馬尾
                drawPigtail(leftEar.position.x, leftEar.position.y, hairWidth, hairLength, -1);
                
                // 畫右邊馬尾
                drawPigtail(rightEar.position.x, rightEar.position.y, hairWidth, hairLength, 1);

                // 畫電子介面文字
                ctx.fillStyle = "#39C5BB";
                ctx.font = "16px monospace";
                ctx.fillText("TARGET: MASTER", leftEar.position.x - 50, leftEar.position.y - 50);
                
                // 更新狀態顯示
                statusDiv.innerText = "MIKU 同步率: 100% (已偵測)";
                statusDiv.style.background = "rgba(225, 0, 141, 0.8)"; // 變成洋紅色
            } else {
                statusDiv.innerText = "搜尋目標中...";
                statusDiv.style.background = "rgba(57, 197, 187, 0.8)";
            }
        }

        // 繪製單根馬尾的函式
        function drawPigtail(x, y, w, h, direction) {
            ctx.beginPath();
            // 馬尾根部
            ctx.moveTo(x, y); 
            // 貝茲曲線畫出飄逸感
            // cp1x, cp1y, cp2x, cp2y, x, y
            ctx.bezierCurveTo(
                x + (direction * w * 2), y + (h * 0.3), // 控制點 1 (向外飄)
                x + (direction * w * 0.5), y + (h * 0.8), // 控制點 2 (收回來)
                x + (direction * w), y + h // 終點
            );
            // 畫回去形成封閉圖形
            ctx.bezierCurveTo(
                x - (direction * w * 0.5), y + (h * 0.8),
                x + (direction * w), y + (h * 0.3),
                x, y
            );
            ctx.fill();
            ctx.stroke();
            
            // 髮飾 (方形)
            ctx.fillStyle = "#e1008d"; // Miku Magenta
            ctx.fillRect(x - 10, y - 10, 20, 20);
            ctx.fillStyle = "rgba(57, 197, 187, 0.8)"; // 改回綠色給下一次用
        }

        // 3. 主循環
        async function detect() {
            // 透過 PoseNet 估算姿勢
            const pose = await net.estimateSinglePose(video, {
                flipHorizontal: false // 我們在 CSS 翻轉了 Canvas，這裡不用翻轉數據
            });

            // 清除畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 繪製影像
            ctx.save();
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.restore();

            // 繪製 AR 特效
            drawMikuHair(pose.keypoints);

            requestAnimationFrame(detect);
        }

        // 4. 初始化程式
        async function main() {
            try {
                await setupCamera();
                video.play();

                // 設定 Canvas 大小符合影片
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                statusDiv.innerText = "正在下載 AI 模型 (首次需連網)...";
                
                // 載入模型 (使用較輕量的 MobileNetV1)
                net = await posenet.load({
                    architecture: 'MobileNetV1',
                    outputStride: 16,
                    inputResolution: { width: 640, height: 480 },
                    multiplier: 0.75
                });

                statusDiv.innerText = "系統啟動完成！(可開啟飛航模式)";
                detect();

            } catch (e) {
                statusDiv.innerText = "錯誤: " + e.message;
                console.error(e);
            }
        }

        main();
    </script>
</body>
</html>
